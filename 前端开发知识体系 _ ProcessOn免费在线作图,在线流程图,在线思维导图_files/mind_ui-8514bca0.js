var Outline={init:function(e,t,n){this.opts=$.extend({listType:"dot",indent:"default",target:"outline-con",line:{show:!1}},e),this.designer=document.getElementById(e.target),null!=t?this.controller.renderAll():this.controller.add(),this.controller.initEvent()},initNodeEvent:function(n){var t=document,o=n.querySelector(".node-self");o.addEventListener("mouseenter",function(e){Outline.controller.posNodeBg(o,"hover"),e.stopPropagation()}),o.addEventListener("mouseleave",function(e){t.querySelector(".outline-hover-bg");e.stopPropagation()}),o.addEventListener("mousedown",function(e){var t=n.getAttribute("id").replace("ol_","");mind.util.selectById.call(mind,t),e.stopPropagation()}),$("#ol_root").off().on("click",function(){mind.util.selectById.call(mind,"root")}),this.opts.readOnly},controller:{setTitle:function(e){$(Outline.designer).prev().html(e).attr("id","ol_root")},renderAll:function(e){var t=mind.model.topic,n=Outline.designer;if(e)return document.querySelector("#ol_"+e.id).innerHTML="",this.add(null,e),void((o=e.children)&&!e.collapsed&&this.renderChild(o));var o=t.children||[],l=t.leftChildren||[];this.setTitle(t.title),n.innerHTML="";var r=o.concat(l);0!=r.length&&this.renderChild(r,n)},renderChild:function(e,t){for(var n=0,o=e.length;n<o;n++){var l=e[n];if(this.add(null,l,t),0<l.children.length&&(null==l.collapsed||!l.collapsed)){var r=l.children;this.renderChild(r)}}},add:function(e,t,n){var o=document,l=Outline.opts,r=(Outline.model,t?t.id:util.newId()),i=null,d=o.querySelector("#ol_"+r);d?i=d:(i=o.createElement("div"),"wider"==l.indent?i.setAttribute("class","node-element wider"):i.setAttribute("class","node-element"),i.setAttribute("id","ol_"+r),null!=t&&(null==n&&(n=o.getElementById("ol_"+t.parent).querySelector(".node-children")),n.appendChild(i)));var c=o.createElement("div");c.setAttribute("class","node-self"),i.appendChild(c);var s=o.createElement("span");c.appendChild(s);var a=o.createElement("span");s.appendChild(a);var u=o.createElement("div");u.setAttribute("class","node-title"),l.readOnly||u.setAttribute("contenteditable",!0),u.setAttribute("spellcheck","false"),u.setAttribute("autocapitalize","off");var h=t?t.title:"";u.innerHTML=h.replace("<br>"," "),c.appendChild(u);var p=o.createElement("div"),v="node-children";l.line.show&&(v+=" line"),l.line.dashed&&(v+=" dashed"),p.setAttribute("class",v),i.appendChild(p),"num"==l.listType?s.setAttribute("class","node-type num"):s.setAttribute("class","node-type dot"),null!=t?this.addStateIcon(t,i):u.focus(),Outline.initNodeEvent(i)},addStateIcon:function(e,t){var n=document,o=t.querySelector(".node-state"),l=t.querySelector(".node-self");if(0<e.children.length&&null==o){(o=n.createElement("div")).setAttribute("class","node-state");var r=n.createElement("span");e.collapsed?r.setAttribute("class","collapse-icon closeIcon"):r.setAttribute("class","collapse-icon openIcon"),o.appendChild(r),l.appendChild(o)}},selectNodeById:function(e){var t=document.querySelector("#ol_"+e),n=null;n="root"==e?t:t.querySelector(".node-self"),this.selectNode(n)},updateNodeById:function(e){var t=e.id,n=e.insertChild;if("root"!=t){if(n||"current"==e.rebuild){var o=document.querySelector("#ol_"+t),l=this.getNodeById(t);return(r=o.querySelector(".node-children"))&&(r.innerHTML=""),void this.renderAll(l)}var r,i=this.getParentNodeById(t);if("root"!=i.id)(r=(o=document.querySelector("#ol_"+i.id)).querySelector(".node-children"))&&(r.innerHTML=""),this.renderAll(i);else this.renderAll()}else this.renderAll()},foldNodeById:function(e){var t=e.type,n=e.id;"show"!=t?this.closeChildren("ol_"+n):this.openChildren("ol_"+n)},nodePosUpdate:function(e){var t=e.id,n=e.target;if("root"==n)this.renderAll();else{var o=document.querySelector("#ol_"+n),l=this.getNodeById(n),r=o.querySelector(".node-children");r&&(r.innerHTML=""),this.renderChild(l.children)}if(t!=n)if("root"==t)this.renderAll();else{var i=this.getNodeById(t),d=document.querySelector("#ol_"+t).querySelector(".node-children");d&&(d.innerHTML=""),this.renderChild(i.children)}},openChildren:function(e){var t=this.getNodeById(e.replace("ol_","")),n=document.querySelector("#"+e),o=n.querySelector(".node-children");o&&(o.innerHTML=""),this.renderChild(t.children),$(o).show();var l=n.querySelector(".collapse-icon");l&&(l.classList.remove("closeIcon"),l.classList.remove("openIcon"),l.classList.add("openIcon"))},closeChildren:function(e){var t=document.getElementById(e),n=t.querySelector(".node-children");$(n).hide();var o=t.querySelector(".collapse-icon");o&&(o.classList.remove("openIcon"),o.classList.remove("closeIcon"),o.classList.add("closeIcon"))},selectNode:function(e){this.posNodeBg(e,"current")},posNodeBg:function(e,t){"hover"==t&&document.querySelector(".outline-hover-bg"),"current"==t&&document.querySelector(".outline-curt-bg");e.getBoundingClientRect()},getNodeById:function(e){return mind.model.getTopicById(e)},getParentNodeById:function(e){e=e.replace("ol_","");var t=mind.model.getTopicById(e);return mind.model.getTopicById(t.parent)},initEvent:function(){var l=this;$(document).on("click",".node-state",function(e){var t=$(this),n=t.parent().parent().attr("id"),o=$(t.children()[0]);o.hasClass("openIcon")?(l.closeChildren(n),o.removeClass("openIcon").addClass("closeIcon")):(l.openChildren(n),o.removeClass("closeIcon").addClass("openIcon")),e.stopPropagation()})}},util:{newId:function(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+""+e()+e()+e()},copy:function(e){return $.extend({},e)},getElementIndex:function(e){return $(e).index()},getCurrentDate:function(){var e=new Date,t=[],n=[];return t.push(e.getFullYear()),t.push(e.getMonth()+1),t.push(e.getDate()),n.push(e.getHours()),n.push(e.getMinutes()),n.push(e.getSeconds()),t.join("-")+" "+n.join(":")},moveToEnd:function(e){document.getElementById(e).setSelectionRange(1,1)},removeAttribute:function(e,t){if(e&&t)for(var n=0,o=e.length;n<o;n++){e[n].removeAttribute(t)}},setCursorPosition:function(e,t){var n=document.getElementById("ol_"+e);if(null!=n){var o=n.querySelector(".node-title");null==t&&(t=o.innerText.length);var l=o.childNodes[0];if(null!=l){var r=document.createRange(),i=window.getSelection();r.setStart(l,t),r.setEnd(l,t),r.collapse(!0),i.removeAllRanges(),i.addRange(r),o.focus()}else o.focus()}}}};function loadOutline(){var e=mind.model.topic;Outline.init({target:"outline-container",line:{show:!0},readOnly:!0,indent:"wider"},e)}